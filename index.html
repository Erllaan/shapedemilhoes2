<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Treinos Personalizado para Alunos</title>
    <!-- Inclui a biblioteca jsPDF para gera√ß√£o de PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.21/jspdf.plugin.autotable.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2b5876, #4e4376); /* Gradiente suave */
            color: #fff;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
            line-height: 1.6;
        }

        .container {
            background-color: rgba(255, 255, 255, 0.1); /* Fundo semi-transparente claro */
            backdrop-filter: blur(10px); /* Efeito de vidro fosco */
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
            width: 100%;
            max-width: 900px;
            box-sizing: border-box;
            animation: fadeIn 1s ease-out;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1 {
            text-align: center;
            color: #a8dadc; /* Azul claro */
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.6);
            letter-spacing: 1px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #e0f2f7;
            font-size: 1.1em;
        }

        .input-group input[type="text"],
        .input-group select,
        .input-group textarea {
            width: calc(100% - 24px); /* Ajuste para padding e borda */
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            background-color: rgba(255, 255, 255, 0.15);
            color: #fff;
            font-size: 1em;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            /* Garante que o texto dentro do select seja leg√≠vel no Safari/Chrome */
            -webkit-appearance: none; /* Remove estilo padr√£o do navegador */
            -moz-appearance: none;    /* Remove estilo padr√£o do navegador */
            appearance: none;         /* Remove estilo padr√£o do navegador */
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23ffffff%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13.2-6.5h-258a17.6%2017.6%200%200%00-13.2%206.5%2017.6%2017.6%200%200%200%200%2022.2l128.6%20127.9c4.2%204.1%2011%204.1%2015.2%200l128.6-127.9a17.6%2017.6%200%200%200%200-22.2z%22%2F%3E%3C%2Fsvg%3E'); /* Seta branca personalizada */
            background-repeat: no-repeat;
            background-position: right 10px top 50%;
            background-size: 12px auto;
        }
        
        /* Ajuste espec√≠fico para as op√ß√µes dentro do select */
        .input-group select option {
            background-color: #1d3557; /* Fundo escuro para as op√ß√µes */
            color: #fff; /* Texto branco */
        }

        .input-group textarea {
            min-height: 80px; /* Altura m√≠nima para observa√ß√µes */
            resize: vertical; /* Permite redimensionar verticalmente */
        }

        .input-group input[type="text"]:focus,
        .input-group select:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: #a8dadc;
            box-shadow: 0 0 0 4px rgba(168, 218, 220, 0.4);
            background-color: rgba(255, 255, 255, 0.25);
        }

        button {
            display: block;
            width: 100%;
            padding: 15px;
            margin-top: 25px;
            background-color: #457b9d; /* Azul m√©dio */
            color: #fff;
            border: none;
            border-radius: 10px;
            font-size: 1.3em;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        button:hover {
            background-color: #1d3557; /* Azul escuro */
            transform: translateY(-3px);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.4);
        }

        button#exportPdfBtn {
            background-color: #f4a261; /* Laranja suave */
            margin-top: 15px;
        }

        button#exportPdfBtn:hover {
            background-color: #e76f51; /* Laranja mais forte */
        }

        /* Estilos para a nova se√ß√£o de dias personalizados */
        #customDivisionsContainer {
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin-top: 10px;
            background-color: rgba(0, 0, 0, 0.2);
        }

        .custom-day-entry {
            background-color: rgba(255, 255, 255, 0.08);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .custom-day-entry:last-child {
            margin-bottom: 0;
        }

        .custom-day-entry label {
            font-size: 1em;
            margin-bottom: 5px;
            color: #e0f2f7;
        }

        /* Estilo para o grupo de checkboxes dentro do dia personalizado */
        .custom-day-entry .muscle-selection-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 5px;
            margin-bottom: 15px; /* Espa√ßo antes do bot√£o remover */
        }

        .custom-day-entry .muscle-selection-group label {
            display: flex;
            align-items: center;
            font-size: 0.95em;
            cursor: pointer;
            background-color: rgba(255, 255, 255, 0.1);
            padding: 8px 12px;
            border-radius: 5px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: background-color 0.2s ease;
        }
        
        .custom-day-entry .muscle-selection-group label:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .custom-day-entry .muscle-selection-group input[type="checkbox"] {
            margin-right: 8px;
            transform: scale(1.1);
            accent-color: #457b9d;
        }

        .custom-day-entry .remove-day-btn {
            width: 100px;
            padding: 8px 10px;
            margin: 0;
            font-size: 0.9em;
            background-color: #e76f51; /* Cor para remover */
            display: block; /* Para ocupar a largura total em mobile */
            margin-left: auto; /* Alinhar √† direita em desktop */
            margin-right: auto; /* Centralizar em mobile */
            box-shadow: none;
        }

        .custom-day-entry .remove-day-btn:hover {
            background-color: #d64a2e;
            transform: none;
        }

        #addCustomDayBtn {
            margin-top: 15px;
            background-color: #2a9d8f; /* Cor para adicionar dia */
        }

        #addCustomDayBtn:hover {
            background-color: #218579;
        }


        #resultado {
            background-color: rgba(0, 0, 0, 0.4);
            padding: 30px;
            margin-top: 30px;
            border-radius: 15px;
            white-space: pre-wrap;
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 0.95em;
            line-height: 1.8;
            color: #e0e0e0;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.6);
            max-height: 70vh;
            overflow-y: auto;
            text-align: left;
        }

        #resultado h2 {
            color: #a8dadc;
            font-size: 1.8em;
            margin-bottom: 15px;
            border-bottom: 1px dashed rgba(255, 255, 255, 0.3);
            padding-bottom: 5px;
        }

        #resultado h3 {
            color: #a8dadc;
            font-size: 1.4em;
            margin-top: 25px;
            margin-bottom: 10px;
        }

        #resultado strong {
            color: #f4a261; /* Laranja para destaque */
        }

        .checkbox-group { /* Mantido para t√©cnicas avan√ßadas e opcionais */
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 10px;
        }

        .checkbox-group label {
            display: flex;
            align-items: center;
            font-size: 1em;
            cursor: pointer;
        }

        .checkbox-group input[type="checkbox"] {
            margin-right: 8px;
            transform: scale(1.3);
            accent-color: #457b9d; /* Cor do checkbox */
        }

        /* Estilo espec√≠fico para o novo grupo de checkboxes de √™nfase */
        #muscleEmphasisContainer {
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin-top: 10px;
            background-color: rgba(0, 0, 0, 0.2);
        }
        #muscleEmphasisContainer .muscle-emphasis-checkbox-group label {
            background-color: rgba(255, 255, 255, 0.1);
            padding: 8px 12px;
            border-radius: 5px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: background-color 0.2s ease;
        }
        #muscleEmphasisContainer .muscle-emphasis-checkbox-group label:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        #muscleEmphasisContainer .muscle-emphasis-checkbox-group input[type="checkbox"] {
            accent-color: #f4a261; /* Cor de destaque para √™nfase */
        }


        /* Responsividade */
        @media (max-width: 768px) {
            .container {
                padding: 25px;
                margin: 10px;
            }
            h1 {
                font-size: 2em;
            }
            button {
                font-size: 1.1em;
                padding: 12px;
            }
            .custom-day-entry .remove-day-btn {
                width: 100%; /* Bot√£o remover ocupa toda a largura */
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚ú® Gerador de Treinos Personalizados para Alunos ‚ú®</h1>

        <div class="input-group">
            <label for="nomeAluno">Nome do Aluno:</label>
            <input type="text" id="nomeAluno" placeholder="Nome completo do aluno" required>
        </div>

        <div class="input-group">
            <label for="sexo">Sexo:</label>
            <select id="sexo">
                <option value="Masculino">Masculino</option>
                <option value="Feminino">Feminino</option>
                <option value="Outro">Outro</option>
            </select>
        </div>

        <div class="input-group">
            <label for="nivel">N√≠vel de Treinamento:</label>
            <select id="nivel">
                <option value="Iniciante">Iniciante</option>
                <option value="Intermediario">Intermedi√°rio</option>
                <option value="Avancado">Avan√ßado</option>
            </select>
        </div>

        <div class="input-group">
            <label for="objetivo">Objetivo do Treino:</label>
            <select id="objetivo">
                <option value="Hipertrofia">Hipertrofia (Ganho de Massa Muscular)</option>
                <option value="Emagrecimento">Emagrecimento (Perda de Gordura)</option>
                <option value="Forca">For√ßa (Aumento de Cargas)</option>
                <option value="Resistencia">Resist√™ncia Muscular</option>
            </select>
        </div>

        <!-- Nova se√ß√£o para configurar dias de treino personalizados -->
        <div class="input-group">
            <label>Configura√ß√£o dos Dias de Treino:</label>
            <div id="customDivisionsContainer">
                <!-- Dias de treino personalizados ser√£o adicionados aqui via JS -->
            </div>
            <button type="button" id="addCustomDayBtn" onclick="addCustomDay()">Adicionar Dia de Treino</button>
        </div>
        <!-- Fim da nova se√ß√£o -->

        <div class="input-group">
            <label>Exerc√≠cios Opcionais (Selecione para incluir):</label>
            <div class="checkbox-group">
                <label><input type="checkbox" id="includeElastic" class="optional-exercise" value="Faixa El√°stica"> Incluir Exerc√≠cios com Faixa El√°stica</label>
                <label><input type="checkbox" id="includeBodyweight" class="optional-exercise" value="Peso Corporal"> Incluir Exerc√≠cios com Peso Corporal (Flex√µes, etc.)</label>
                <label><input type="checkbox" id="includeCables" class="optional-exercise" value="Cabos"> Incluir Exerc√≠cios com Cabos</label>
                <label><input type="checkbox" id="includeKettlebell" class="optional-exercise" value="Kettlebell"> Incluir Exerc√≠cios com Kettlebell</label>
            </div>
        </div>

        <!-- Nova se√ß√£o para sele√ß√£o de √™nfase muscular (m√∫ltipla) -->
        <div class="input-group">
            <label>M√∫sculos para Dar √änfase (Opcional):</label>
            <div id="muscleEmphasisContainer">
                <div class="checkbox-group muscle-emphasis-checkbox-group" id="muscleEmphasisCheckboxes">
                    <!-- Checkboxes de √™nfase ser√£o populados aqui via JS -->
                </div>
            </div>
        </div>
        <!-- Fim da nova se√ß√£o -->

        <div class="input-group">
            <label>T√©cnicas Avan√ßadas (Opcional):</label>
            <div class="checkbox-group">
                <label><input type="checkbox" class="tecnica-avancada" value="Drop set"> Drop set</label>
                <label><input type="checkbox" class="tecnica-avancada" value="Pir√¢mide"> Pir√¢mide</label>
                <label><input type="checkbox" class="tecnica-avancada" value="Superset"> Superset</label>
                <label><input type="checkbox" class="tecnica-avancada" value="Rest-pause"> Rest-pause</label>
                <label><input type="checkbox" class="tecnica-avancada" value="FST-7"> FST-7</label>
                <label><input type="checkbox" class="tecnica-avancada" value="Bi-set"> Bi-set</label>
                <label><input type="checkbox" class="tecnica-avancada" value="Cluster set"> Cluster set</label>
                <label><input type="checkbox" class="tecnica-avancada" value="Myo-reps"> Myo-reps</label>
            </div>
        </div>

        <div class="input-group">
            <label for="observacoesGerais">Observa√ß√µes Gerais para o Aluno:</label>
            <textarea id="observacoesGerais" placeholder="Ex: 'Focar na boa execu√ß√£o', 'Lembre-se da hidrata√ß√£o'." rows="3"></textarea>
        </div>

        <button onclick="gerarTreino()">Gerar Treino</button>
        <button id="exportPdfBtn" onclick="exportarTreinoParaPDF()">Exportar para PDF</button>

        <div id="resultado">
            <p>O seu treino ser√° gerado aqui!</p>
        </div>
    </div>

    <script>
        // Dados brutos dos exerc√≠cios fornecidos pelo utilizador
        const rawExerciseData = `
PEITO
Supino reto com barra
Supino reto com halteres
Supino inclinado com barra
Supino inclinado com halteres
Supino declinado com barra
Supino declinado com halteres
Crucifixo reto com halteres
Crucifixo inclinado com halteres
Crucifixo declinado com halteres
Crossover no cross
Crossover alto no cross
Crossover baixo no cross
Flex√£o de bra√ßo tradicional
Flex√£o de bra√ßo inclinada
Flex√£o de bra√ßo declinada
Flex√£o de bra√ßo com pegada aberta
Flex√£o de bra√ßo com pegada fechada
Peck deck (voador)
Supino no smith (reto, inclinado ou declinado)
Crucifixo na m√°quina
COSTAS
Puxada frente na polia alta
Puxada atr√°s na polia alta
Puxada com tri√¢ngulo
Remada baixa com triangulo
Remada curvada com barra
Remada curvada com halteres
Remada unilateral com halteres
Remada cavalinho (T-bar)
Remada alta no cross
Remada m√°quina articulada
Remada sentado no cabo
Remada em p√© no cross
Remada no smith
Barra fixa (pegada pronada)
Barra fixa (pegada supinada)
Barra fixa com pegada neutra
Pullover com halteres
Pullover na m√°quina
Pullover no cross
Face pull
TRAP√âZIO
Encolhimento com halteres
Encolhimento com barra
Encolhimento com barra atr√°s
Encolhimento no smith
Encolhimento unilateral com halteres
Encolhimento com barra hexagonal
Encolhimento isom√©trico com barra
Encolhimento com kettlebell
Remada alta com barra ou halteres
DELTOIDES (OMBRO)
Desenvolvimento com barra
Desenvolvimento com halteres
Desenvolvimento no smith
Eleva√ß√£o lateral com halteres
Eleva√ß√£o lateral no cross
Eleva√ß√£o frontal com halteres
Eleva√ß√£o frontal no cross
Eleva√ß√£o unilateral (lateral ou frontal)
Eleva√ß√£o lateral inclinada
Crucifixo inverso com halteres
Crucifixo inverso no cross
Remada alta com barra
Remada alta no cabo
Desenvolvimento Arnold
Desenvolvimento na m√°quina
Eleva√ß√£o lateral na m√°quina
B√çCEPS
Rosca direta com barra
Rosca direta com halteres
Rosca alternada com halteres
Rosca martelo
Rosca concentrada
Rosca scott (barra ou halteres)
Rosca no cross (cabo baixo)
Rosca unilateral no cross
Rosca inversa
Rosca 21
Rosca com barra W
Rosca unilateral no banco inclinado
Rosca spider
Rosca no banco inclinado com halteres
TR√çCEPS
Tr√≠ceps na polia alta (barra ou corda)
Tr√≠ceps testa com barra ou halteres
Tr√≠ceps banco (mergulho)
Tr√≠ceps coice
Tr√≠ceps franc√™s com halteres
Tr√≠ceps franc√™s com barra
Tr√≠ceps unilateral no cross
Tr√≠ceps no cross com barra V
Tr√≠ceps no cross com corda
Tr√≠ceps kickback unilateral
Tr√≠ceps supinado com halteres
Tr√≠ceps na m√°quina
Tr√≠ceps no cross atr√°s da cabe√ßa
QUADR√çCEPS
Agachamento livre
Agachamento no smith
Agachamento hack
Agachamento frontal
Agachamento sum√¥
Avan√ßo (passada) com barra
Avan√ßo com halteres
Avan√ßo no smith
Cadeira extensora
Agachamento b√∫lgaro
Agachamento unilateral no banco
Agachamento com barra frontal
Agachamento com kettlebell
Agachamento isom√©trico
Agachamento com salto
Pistol squat (agachamento unilateral)
Agachamento na m√°quina guiada
Step-up com halteres
Agachamento sum√¥ com kettlebell
Cadeira extensora unilateral
POSTERIOR DE COXA (ISQUIOTIBIAIS)
Mesa flexora
Flexora unilateral
Stiff com barra
Stiff com halteres
Stiff unilateral
Levantamento terra romeno
Flexora em p√©
Flexora sentada
Cadeira flexora isolada
Flex√£o n√≥rdica
Levantamento terra com pernas r√≠gidas
Flex√£o de joelhos no TRX
Eleva√ß√£o de quadril com bola
Glute bridge com isometria
Stiff com kettlebell
Flex√£o com bola su√≠√ßa
Flexora com halteres entre os p√©s
Stiff unilateral com halteres
Flex√£o no cross com caneleira
Flexora bilateral com halteres
GL√öTEOS
Eleva√ß√£o p√©lvica com barra (hip thrust)
Eleva√ß√£o p√©lvica unilateral
Glute bridge no solo
Glute bridge com barra
Extens√£o de quadril no cross
Extens√£o de quadril com caneleira
Cadeira abdutora
Stiff com foco no gl√∫teo
Agachamento sum√¥
Passada com halteres
Agachamento b√∫lgaro
Step-up com halteres
Kickback no cross
Kickback com caneleira
Ponte com bola
Glute bridge isom√©trico
Extens√£o com faixa el√°stica
Ponte unilateral
Hip thrust no smith
Abdu√ß√£o lateral com el√°stico
PANTURRILHAS
Eleva√ß√£o plantar em p√©
Eleva√ß√£o plantar sentado
Eleva√ß√£o plantar na leg press
Eleva√ß√£o plantar unilateral
Eleva√ß√£o plantar com halteres
Eleva√ß√£o plantar no smith
Eleva√ß√£o plantar na escada
Eleva√ß√£o com kettlebell
Eleva√ß√£o na m√°quina espec√≠fica
Eleva√ß√£o em degrau (calcanhar fora)
Eleva√ß√£o plantar com barra
Saltos com foco na panturrilha
Isometria em eleva√ß√£o
Eleva√ß√£o com uma perna s√≥
Caminhada na ponta dos p√©s
Pliometria para panturrilhas
Panturrilha no hack
Panturrilha no step
Panturrilha unilateral com peso
Panturrilha no crossover
ABD√îMEN
Abdominal tradicional no solo
Abdominal infra com pernas elevadas
Abdominal infra na barra
Abdominal obl√≠quo no solo
Abdominal bicicleta
Prancha isom√©trica
Prancha lateral
Prancha com eleva√ß√£o de perna
Prancha com apoio nos cotovelos
Eleva√ß√£o de pernas no banco declinado
Eleva√ß√£o de pernas na cadeira romana
Abdominal com bola su√≠√ßa
Abdominal com corda no cross
Abdominal com carga
Abdominal com rolo (ab wheel)
Abdominal no banco inclinado
Abdominal canivete
Abdominal com eleva√ß√£o de quadril
Abdominal com tor√ß√£o
Abdominal com kettlebell
CARDIOVASCULARES / AER√ìBIOS
Caminhada na esteira
Corrida na esteira
Bicicleta ergom√©trica
Bicicleta spinning
Subir escadas
Corrida ao ar livre
Caminhada acelerada
Polichinelo
Corrida estacion√°ria
Corrida com joelhos altos
Corrida com calcanhar no gl√∫teo
Pular corda
Jump (trampolim)
Escalador (mountain climbers)
Burpees
Sprints curtos (tiros)
Escada de agilidade
HIIT na esteira
Saltos pliom√©tricos
Dan√ßa aer√≥bica
`;

        // Helper function to infer equipment from exercise name
        function inferEquipment(exerciseName) {
            const lowerName = exerciseName.toLowerCase();
            if (lowerName.includes("barra fixa") || lowerName.includes("pull-up") || lowerName.includes("chin-up") || lowerName.includes("paralelas")) {
                return ["Barra Fixa / Paralela"];
            }
            if (lowerName.includes("barra") && !lowerName.includes("barra v") && !lowerName.includes("barra t")) { // Exclude specific bar types that are accessories
                return ["Barra"];
            }
            if (lowerName.includes("halteres") || lowerName.includes("halter")) {
                return ["Halteres"];
            }
            if (lowerName.includes("kettlebell")) { // Specific entry for kettlebell
                return ["Kettlebell"];
            }
            if (lowerName.includes("m√°quina") || lowerName.includes("smith") || lowerName.includes("peck deck") || lowerName.includes("leg press") || lowerName.includes("cadeira extensora") || lowerName.includes("mesa flexora") || lowerName.includes("hack") || lowerName.includes("cadeira abdutora") || lowerName.includes("supino guiado") || lowerName.includes("remada m√°quina articulada") || lowerName.includes("eleva√ß√£o na m√°quina espec√≠fica") || lowerName.includes("panturrilha no hack")) {
                return ["M√°quina"];
            }
            if (lowerName.includes("cabo") || lowerName.includes("cross-over") || lowerName.includes("polia") || lowerName.includes("crossover") || lowerName.includes("face pull") || lowerName.includes("remada em p√© no cross") || lowerName.includes("kickback no cross") || lowerName.includes("panturrilha no crossover")) { // Specific entry for cables
                return ["Cabos"];
            }
            if (lowerName.includes("solo") || lowerName.includes("bra√ßo") || lowerName.includes("p√©s") || lowerName.includes("banco") || lowerName.includes("pistol squat") || lowerName.includes("flex√£o") || lowerName.includes("prancha") || lowerName.includes("abdominal") || lowerName.includes("roda abdominal") || lowerName.includes("ab wheel") || lowerName.includes("caneleira") || lowerName.includes("glute bridge") || lowerName.includes("ponte") || lowerName.includes("wall sit") || lowerName.includes("flex√£o n√≥rdica") || lowerName.includes("corrida ao ar livre") || lowerName.includes("caminhada acelerada") || lowerName.includes("polichinelo") || lowerName.includes("corrida estacion√°ria") || lowerName.includes("corrida com joelhos altos") || lowerName.includes("corrida com calcanhar no gl√∫teo") || lowerName.includes("pular corda") || lowerName.includes("jump") || lowerName.includes("escalador") || lowerName.includes("burpees") || lowerName.includes("sprints") || lowerName.includes("escada de agilidade") || lowerName.includes("saltos pliom√©tricos") || lowerName.includes("dan√ßa aer√≥bica")) {
                return ["Peso Corporal"];
            }
            if (lowerName.includes("el√°stico") || lowerName.includes("trx") || lowerName.includes("faixa el√°stica")) {
                return ["Faixa El√°stica"];
            }
            if (lowerName.includes("bola su√≠√ßa") || lowerName.includes("bola medicinal") || lowerName.includes("rolo")) {
                return ["Outros Acess√≥rios"];
            }
            if (lowerName.includes("esteira") || lowerName.includes("bicicleta") || lowerName.includes("spinning") || lowerName.includes("escadas")) {
                return ["M√°quina de Cardio"];
            }
            // Fallback for exercises that don't clearly imply equipment
            return ["Diversos"]; 
        }

        // Helper to determine exercise difficulty (new function)
        function determineDifficulty(exerciseName, group) {
            const lowerName = exerciseName.toLowerCase();

            if (group === "Cardio") {
                if (lowerName.includes("caminhada") || lowerName.includes("polichinelo") || lowerName.includes("corrida estacion√°ria") || lowerName.includes("bicicleta ergom√©trica")) {
                    return "Iniciante";
                }
                if (lowerName.includes("corrida na esteira") || lowerName.includes("subir escadas") || lowerName.includes("pular corda") || lowerName.includes("jump") || lowerName.includes("escalador") || lowerName.includes("bicicleta spinning")) {
                    return "Intermediario";
                }
                if (lowerName.includes("sprints") || lowerName.includes("burpees") || lowerName.includes("hiit") || lowerName.includes("saltos pliom√©tricos") || lowerName.includes("dan√ßa aer√≥bica") || lowerName.includes("escada de agilidade")) {
                    return "Avancado";
                }
                return "Intermediario"; // Default for cardio if not specific
            }

            // Existing logic for strength exercises (refined)
            // Iniciante keywords
            if (lowerName.includes("m√°quina") || lowerName.includes("sentado") || lowerName.includes("guiado") || lowerName.includes("colchonete") || lowerName.includes("solo") || lowerName.includes("banco") || lowerName.includes("el√°stico") || lowerName.includes("step (peso corporal)") || lowerName.includes("wall sit") || lowerName.includes("cadeira abdutora") || lowerName.includes("mesa flexora") || lowerName.includes("cadeira extensora") || lowerName.includes("voador") || lowerName.includes("crucifixo na m√°quina") || lowerName.includes("remada sentado no cabo") || lowerName.includes("tr√≠ceps na m√°quina") || lowerName.includes("flex√£o de bra√ßo tradicional") || lowerName.includes("abdominal tradicional no solo") || lowerName.includes("prancha isom√©trica") || lowerName.includes("glute bridge no solo") || lowerName.includes("eleva√ß√£o plantar em p√©") || lowerName.includes("encolhimento com halteres")) {
                return "Iniciante";
            }
            // Avan√ßado keywords
            if (lowerName.includes("livre") || (lowerName.includes("barra") && !lowerName.includes("m√°quina") && !lowerName.includes("smith") && !lowerName.includes("barra w") && !lowerName.includes("barra t")) || (lowerName.includes("halteres") && !lowerName.includes("m√°quina")) || lowerName.includes("pistol squat") || lowerName.includes("handstand push-up") || lowerName.includes("dragon flag") || lowerName.includes("levantamento terra") || lowerName.includes("push press") || lowerName.includes("arnold press") || lowerName.includes("flex√£o n√≥rdica") || lowerName.includes("paralelas") || lowerName.includes("agachamento hack") || lowerName.includes("agachamento b√∫lgaro") || lowerName.includes("barra fixa") || lowerName.includes("remada curvada") || lowerName.includes("stiff") || lowerName.includes("hip thrust") || lowerName.includes("abdominal infra na barra") || lowerName.includes("abdominal com rolo") || lowerName.includes("abdominal canivete") || lowerName.includes("abdominal com eleva√ß√£o de quadril") || lowerName.includes("remada cavalinho") || lowerName.includes("encolhimento com barra hexagonal") || lowerName.includes("encolhimento isom√©trico") || lowerName.includes("tr√≠ceps testa") || lowerName.includes("tr√≠ceps franc√™s") || lowerName.includes("flexora unilateral")) {
                return "Avancado";
            }
            // Default to Intermediario
            return "Intermediario";
        }


        // Fun√ß√£o para analisar os dados brutos e estrutur√°-los
        function parseAndStructureExercises(rawData) {
            const lines = rawData.trim().split('\n');
            const strengthExercises = {
                "Peito": { "Iniciante": [], "Intermediario": [], "Avancado": [] },
                "Costas": { "Iniciante": [], "Intermediario": [], "Avancado": [] },
                "Gl√∫teos": { "Iniciante": [], "Intermediario": [], "Avancado": [] }, // Separado
                "Posterior de Coxa": { "Iniciante": [], "Intermediario": [], "Avancado": [] }, // Separado
                "Ombro": { "Iniciante": [], "Intermediario": [], "Avancado": [] },
                "B√≠ceps": { "Iniciante": [], "Intermediario": [], "Avancado": [] },
                "Tr√≠ceps": { "Iniciante": [], "Intermediario": [], "Avancado": [] },
                "Quadr√≠ceps": { "Iniciante": [], "Intermediario": [], "Avancado": [] },
                "Panturrilha": { "Iniciante": [], "Intermediario": [], "Avancado": [] },
                "Abd√¥men": { "Iniciante": [], "Intermediario": [], "Avancado": [] },
                "Trap√©zio": { "Iniciante": [], "Intermediario": [], "Avancado": [] } // Novo grupo adicionado
            };

            const cardioExercises = {
                "Iniciante": [],
                "Intermediario": [],
                "Avancado": []
            };

            const allGroupsMap = {
                "PEITO": "Peito",
                "COSTAS": "Costas",
                "TRAP√âZIO": "Trap√©zio", // Mapeamento para o novo grupo
                "DELTOIDES (OMBRO)": "Ombro",
                "B√çCEPS": "B√≠ceps",
                "TR√çCEPS": "Tr√≠ceps",
                "QUADR√çCEPS": "Quadr√≠ceps",
                "POSTERIOR DE COXA (ISQUIOTIBIAIS)": "Posterior de Coxa",
                "GL√öTEOS": "Gl√∫teos",
                "PANTURRILHAS": "Panturrilha",
                "ABD√îMEN": "Abd√¥men",
                "CARDIOVASCULARES / AER√ìBIOS": "Cardio" // Mapeamento para exerc√≠cios de cardio
            };
            let currentGroup = "";

            for (const line of lines) {
                const trimmedLine = line.trim();
                if (!trimmedLine) continue; // Ignora linhas vazias

                // Verifica se a linha √© um cabe√ßalho de grupo muscular ou cardio
                const mappedGroup = allGroupsMap[trimmedLine.toUpperCase()];
                if (mappedGroup) {
                    currentGroup = mappedGroup;
                } else if (currentGroup) {
                    const exerciseName = trimmedLine;
                    const equipment = inferEquipment(exerciseName);
                    const instructions = ""; 
                    const difficulty = determineDifficulty(exerciseName, currentGroup); // Passa o grupo para ajudar na determina√ß√£o da dificuldade

                    if (currentGroup === "Cardio") {
                        cardioExercises[difficulty].push({
                            nome: exerciseName,
                            difficulty: difficulty
                        });
                    } else if (strengthExercises[currentGroup]) {
                        // Adiciona o exerc√≠cio a todos os n√≠veis do grupo de for√ßa
                        strengthExercises[currentGroup]["Iniciante"].push({ nome: exerciseName, grupoPrimario: currentGroup, equipamento: equipment, instrucoes: instructions, difficulty: difficulty });
                        strengthExercises[currentGroup]["Intermediario"].push({ nome: exerciseName, grupoPrimario: currentGroup, equipamento: equipment, instrucoes: instructions, difficulty: difficulty });
                        strengthExercises[currentGroup]["Avancado"].push({ nome: exerciseName, grupoPrimario: currentGroup, equipamento: equipment, instrucoes: instructions, difficulty: difficulty });
                    } else {
                        console.warn(`Grupo muscular n√£o reconhecido ou mapeado incorretamente para o exerc√≠cio "${exerciseName}": ${currentGroup}`);
                    }
                }
            }
            return { strengthExercises, cardioExercises };
        }

        // --- BANCO DE DADOS DE EXERC√çCIOS (Gerado a partir da sua lista) ---
        // As vari√°veis globais agora recebem os objetos retornados pela fun√ß√£o de parsing
        const { strengthExercises, cardioExercises } = parseAndStructureExercises(rawExerciseData);
        const bancoDeExercicios = strengthExercises; // Mant√©m o nome para compatibilidade com o c√≥digo existente


        const aquecimentoAlongamento = {
            "Aquecimento Geral (5-10 minutos)": [
                "Polichinelos (2 min)",
                "Rota√ß√£o de bra√ßos para frente e para tr√°s (1 min)",
                "Rota√ß√£o de tronco suave (1 min)",
                "Agachamento com peso corporal (10-15 reps)",
                "Eleva√ß√£o de joelhos (1 min)",
                "Calcanhares nos gl√∫teos (1 min)",
                "Alongamento din√¢mico de pernas (balan√ßos frontais e laterais) - 2 min",
                "Caminhada com eleva√ß√£o de pernas (1 min)",
                "Rota√ß√£o de tornozelos (30s cada)",
                "Ponte de gl√∫teos (10-15 reps)"
            ]
        };

        // Vari√°vel para armazenar o conte√∫do do treino gerado e ser usado no PDF
        let treinoGeradoConteudoHTML = ""; // Armazenar√° o HTML completo
        // Objeto para armazenar os dados estruturados para o PDF
        let treinoGeradoConteudoParaPDF = {}; 

        // Vari√°veis para gerenciar os dias personalizados
        let dayCounter = 0; // Para gerar IDs e r√≥tulos (Dia A, Dia B...)
        const muscleGroupOptions = [ // Lista de grupos musculares v√°lidos para o input do utilizador
            "Peito", "Costas", "Ombro", "B√≠ceps", "Tr√≠ceps",
            "Quadr√≠ceps", "Posterior de Coxa", "Gl√∫teos", "Panturrilha", "Abd√¥men", "Trap√©zio" // Adicionado Trap√©zio
        ];

        // Fun√ß√£o para adicionar um novo dia de treino personalizado
        function addCustomDay() {
            const container = document.getElementById('customDivisionsContainer');
            const dayId = `custom_day_${dayCounter}`;
            const dayLabel = String.fromCharCode(65 + dayCounter); // A, B, C...

            const dayDiv = document.createElement('div');
            dayDiv.className = 'custom-day-entry input-group';
            dayDiv.id = dayId;
            
            // Cria os checkboxes para cada grupo muscular
            let checkboxesHtml = muscleGroupOptions.map(group => `
                <label>
                    <input type="checkbox" name="${dayId}_group_checkbox" value="${group}">
                    ${group}
                </label>
            `).join('');

            dayDiv.innerHTML = `
                <label>Dia ${dayLabel}: Selecione os Grupos Musculares</label>
                <div class="checkbox-group muscle-selection-group" id="${dayId}_groups_container">
                    ${checkboxesHtml}
                </div>
                <button type="button" class="remove-day-btn" onclick="removeCustomDay('${dayId}')">Remover Dia</button>
            `;
            container.appendChild(dayDiv);
            dayCounter++;
            updateDayLabels(); // Atualiza os r√≥tulos ap√≥s adicionar
        }

        // Fun√ß√£o para remover um dia de treino personalizado
        function removeCustomDay(id) {
            const dayToRemove = document.getElementById(id);
            if (dayToRemove) {
                dayToRemove.remove();
                updateDayLabels(); // Reorganiza os r√≥tulos ap√≥s remover
            }
        }

        // Fun√ß√£o para atualizar os r√≥tulos dos dias (A, B, C...) ap√≥s adicionar/remover
        function updateDayLabels() {
            const dayEntries = document.querySelectorAll('.custom-day-entry');
            dayEntries.forEach((entry, index) => {
                const labelElement = entry.querySelector('label');
                const checkboxesContainer = entry.querySelector('.muscle-selection-group');
                const removeBtn = entry.querySelector('.remove-day-btn');

                const newDayLabel = String.fromCharCode(65 + index);
                const newDayId = `custom_day_${index}`;

                entry.id = newDayId;
                labelElement.textContent = `Dia ${newDayLabel}: Selecione os Grupos Musculares`;
                
                // Atualiza os nomes dos checkboxes para o novo ID do dia
                Array.from(checkboxesContainer.querySelectorAll('input[type="checkbox"]')).forEach(checkbox => {
                    checkbox.name = `${newDayId}_group_checkbox`;
                });

                removeBtn.setAttribute('onclick', `removeCustomDay('${newDayId}')`);
            });
            dayCounter = dayEntries.length; // Garante que o contador esteja correto
        }

        // Adiciona um dia padr√£o ao carregar a p√°gina e popula o dropdown de √™nfase
        window.onload = function() {
            addCustomDay();
            populateMuscleEmphasisCheckboxes(); // Chamada para a nova fun√ß√£o
        };

        // Fun√ß√£o para popular os checkboxes de √™nfase muscular
        function populateMuscleEmphasisCheckboxes() {
            const container = document.getElementById('muscleEmphasisCheckboxes');
            container.innerHTML = ''; // Limpar op√ß√µes existentes antes de popular
            muscleGroupOptions.forEach(group => {
                const label = document.createElement('label');
                label.innerHTML = `
                    <input type="checkbox" class="muscle-emphasis-checkbox" value="${group}">
                    ${group}
                `;
                container.appendChild(label);
            });
        }

        // Fun√ß√£o auxiliar para remover emojis e ajustar o texto para PDF
        function cleanTextForPdf(text) {
            // Remove emojis e outros caracteres especiais que podem causar problemas em PDF ou regex sem 'u' flag
            // Esta regex tenta cobrir uma ampla gama de emojis e s√≠mbolos Unicode sem a flag 'u'
            // Inclui:
            // - Ranges b√°sicos de emoji e s√≠mbolos (U+2000 a U+32FF)
            // - Pares substitutos (surrogate pairs) que representam emojis fora do Basic Multilingual Plane (BMP)
            // - Varia√ß√µes de seletores de apresenta√ß√£o (FE00-FE0F)
            // - Zero Width Joiner (U+200D) e outros modificadores de emoji
            const noEmojis = text.replace(/(\u00a9|\u00ae|[\u2000-\u3300]|\ud83c[\ud000-\udfff]|\ud83d[\ud000-\udfff]|\ud83e[\ud000-\udfff]|[\u2600-\u26FF]|\u2700-\u27BF|\uFE0E|\uFE0F|\u200D)/g, '');
            
            // Substitui negrito HTML por um marcador simples para o PDF
            const cleaned = noEmojis.replace(/<strong>(.*?)<\/strong>/g, '$1') // Remove tags strong
                                    .replace(/<em>(.*?)<\/em>/g, '$1')     // Remove tags em
                                    .replace(/<hr.*?>/g, '\n------------------------------------------------------\n'); // Substitui <hr>

            return cleaned;
        }


        function getSeriesRepeticoes(objetivo, nivel) {
            switch (objetivo) {
                case "Hipertrofia":
                    if (nivel === "Iniciante") return "3x10-12";
                    if (nivel === "Intermediario") return "3-4x8-12";
                    if (nivel === "Avancado") return "4x6-10";
                    break;
                case "Emagrecimento":
                    if (nivel === "Iniciante") return "3x12-15";
                    if (nivel === "Intermediario") return "3-4x12-15";
                    if (nivel === "Avancado") return "4-5x15-20";
                    break;
                case "Forca":
                    if (nivel === "Iniciante") return "3x8-10";
                    if (nivel === "Intermediario") return "3-5x6-8";
                    if (nivel === "Avancado") return "5x3-5";
                    break;
                case "Resistencia":
                    if (nivel === "Iniciante") return "3x15-20";
                    if (nivel === "Intermediario") return "3-4x15-25";
                    if (nivel === "Avancado") return "4-5x20+";
                    break;
                default:
                    return "3x10-12";
            }
            return "3x10-12";
        }

        function getDescanso(objetivo) {
            switch (objetivo) {
                case "Hipertrofia": return "60-90 segundos";
                case "Emagrecimento": return "30-60 segundos";
                case "Forca": return "90-180 segundos";
                case "Resistencia": return "30-45 segundos";
                default: return "60 segundos";
            }
        }

        // Fun√ß√£o para selecionar um n√∫mero aleat√≥rio de itens de uma lista
        function getRandomSubset(arr, numItems) {
            if (numItems >= arr.length) {
                return [...arr]; // Retorna uma c√≥pia completa se o n√∫mero for maior ou igual
            }
            const shuffled = [...arr].sort(() => 0.5 - Math.random());
            return shuffled.slice(0, numItems);
        }

        // --- L√ìGICA DE GERA√á√ÉO DO TREINO ---
        function gerarTreino() {
            const nomeAluno = document.getElementById('nomeAluno').value.trim();
            const sexo = document.getElementById('sexo').value;
            const nivel = document.getElementById('nivel').value;
            const objetivo = document.getElementById('objetivo').value;
            const observacoesGerais = document.getElementById('observacoesGerais').value.trim();
            
            // Obter os grupos musculares selecionados para √™nfase
            const selectedEmphasisMuscles = Array.from(document.querySelectorAll('.muscle-emphasis-checkbox:checked'))
                                                .map(cb => cb.value);
            
            const tecnicasSelecionadas = Array.from(document.querySelectorAll('.tecnica-avancada:checked'))
                                                .map(cb => cb.value);
            const includeElastic = document.getElementById('includeElastic').checked;
            const includeBodyweight = document.getElementById('includeBodyweight').checked;
            const includeCables = document.getElementById('includeCables').checked; 
            const includeKettlebell = document.getElementById('includeKettlebell').checked; 


            const resultadoDiv = document.getElementById('resultado');
            resultadoDiv.innerHTML = ''; // Limpa resultados anteriores

            if (!nomeAluno) {
                alert("Por favor, digite o nome do aluno.");
                return;
            }

            // Coleta e valida os dias de treino personalizados
            const customDivisionsData = [];
            const dayEntries = document.querySelectorAll('.custom-day-entry');
            if (dayEntries.length === 0) {
                alert("Por favor, adicione pelo menos um dia de treino personalizado.");
                return;
            }

            let hasInvalidSelection = false;
            dayEntries.forEach((entry, index) => {
                const dayId = `custom_day_${index}`; // Recalculate dayId based on current index
                const selectedOptions = Array.from(entry.querySelectorAll(`input[name="${dayId}_group_checkbox"]:checked`)).map(cb => cb.value);

                if (selectedOptions.length === 0) {
                    alert(`Dia ${String.fromCharCode(65 + index)}: Por favor, selecione pelo menos um grupo muscular para este dia.`);
                    hasInvalidSelection = true;
                    return;
                }
                customDivisionsData.push({
                    dayName: String.fromCharCode(65 + index),
                    groups: selectedOptions
                });
                // console.log(`Dia ${String.fromCharCode(65 + index)} configurado com grupos: ${selectedOptions.join(', ')}`);
            });

            if (hasInvalidSelection) {
                console.error("Gera√ß√£o de treino interrompida devido a sele√ß√£o inv√°lida de grupos.");
                return; // Para a gera√ß√£o se houver grupos inv√°lidos
            }

            // Prepare structured data for PDF
            treinoGeradoConteudoParaPDF = {
                aluno: nomeAluno,
                sexo: sexo,
                nivel: nivel,
                objetivo: objetivo,
                tecnicas: tecnicasSelecionadas,
                observacoes: observacoesGerais,
                dias: []
            };

            let treinoOutputHTML = `<h2>üèãÔ∏è Treino Personalizado para ${nomeAluno} (${sexo}) üèãÔ∏è</h2>`;
            treinoOutputHTML += `<p><strong>üìä N√≠vel:</strong> ${nivel} | <strong>üéØ Objetivo:</strong> ${objetivo}</p>`;
            
            if (tecnicasSelecionadas.length > 0) {
                treinoOutputHTML += `<p><strong>‚ú® T√©cnicas Avan√ßadas Aplicadas:</strong> ${tecnicasSelecionadas.join(', ')}</p>`;
            }
            
            if (observacoesGerais) {
                treinoOutputHTML += `<p><strong>üìù Observa√ß√µes do Professor:</strong> ${observacoesGerais}</p>`;
            }
            treinoOutputHTML += `\n<hr style="border-color: rgba(255,255,255,0.3);">\n`;


            const tecnicasUnicas = tecnicasSelecionadas.filter(t => t !== "Superset" && t !== "Bi-set");


            customDivisionsData.forEach((diaConfig, i) => {
                const diaLetra = diaConfig.dayName;
                const gruposDoDia = diaConfig.groups;
                
                // Gerar o t√≠tulo do dia
                let tituloDia = `üóìÔ∏è DIA ${diaLetra}: `;
                tituloDia += `${gruposDoDia[0]}`;
                if (gruposDoDia.length > 1) {
                    tituloDia += ` + ${gruposDoDia.slice(1).join(' + ')}`;
                }
                treinoOutputHTML += `<h3>${tituloDia}</h3>\n`;
                
                // Aquecimento (sele√ß√£o aleat√≥ria de 3-4 itens)
                const selectedWarmup = getRandomSubset(aquecimentoAlongamento["Aquecimento Geral (5-10 minutos)"], Math.floor(Math.random() * (4 - 3 + 1)) + 3);
                treinoOutputHTML += `<p><strong>üî• Aquecimento Geral (5-10 min):</strong></p><ul>`;
                selectedWarmup.forEach(item => {
                    treinoOutputHTML += `<li>${item}</li>`;
                });
                treinoOutputHTML += `</ul>\n`;

                const exerciciosJaUsadosNoDia = new Set(); // Para evitar exerc√≠cios repetidos no MESMO dia
                
                let tecnicasAplicadasNesteDia = 0;
                const maxTecnicasPorDia = 2; // Limite de t√©cnicas por dia para treinos personalizados

                // --- Level Differentiation (Volume) ---
                let minBase, maxBase;
                if (nivel === "Iniciante") {
                    minBase = 5; maxBase = 6;
                } else if (nivel === "Intermediario") {
                    minBase = 6; maxBase = 8;
                } else { // Avancado
                    minBase = 7; maxBase = 9;
                }
                let totalExerciciosDesejadosNoDia = Math.floor(Math.random() * (maxBase - minBase + 1)) + minBase;

                // Ajustar o total de exerc√≠cios desejados com base nos m√∫sculos de √™nfase
                const maxExercisesOverall = (nivel === "Avancado" ? 12 : (nivel === "Intermediario" ? 10 : 8)); // Aumentado para acomodar √™nfase
                selectedEmphasisMuscles.forEach(emphasisMuscle => {
                    if (gruposDoDia.includes(emphasisMuscle) && totalExerciciosDesejadosNoDia < maxExercisesOverall) {
                        totalExerciciosDesejadosNoDia++; // Adiciona um exerc√≠cio extra para cada m√∫sculo de √™nfase
                    }
                });
                
                // Calculate base distribution
                let baseExercisesPerGroup = Math.floor(totalExerciciosDesejadosNoDia / gruposDoDia.length);
                let remainder = totalExerciciosDesejadosNoDia % gruposDoDia.length;

                const distribuicaoExerciciosPorGrupo = {};
                gruposDoDia.forEach(grupo => {
                    distribuicaoExerciciosPorGrupo[grupo] = baseExercisesPerGroup;
                });

                // Prioritize distributing remainder to emphasized groups first
                selectedEmphasisMuscles.forEach(emphasisMuscle => {
                    if (gruposDoDia.includes(emphasisMuscle) && remainder > 0) {
                        distribuicaoExerciciosPorGrupo[emphasisMuscle]++;
                        remainder--;
                    }
                });
                // Distribute any remaining remainder to other groups cyclically
                for (let k = 0; k < remainder; k++) {
                    distribuicaoExerciciosPorGrupo[gruposDoDia[k % gruposDoDia.length]]++; 
                }


                let allExercisesFoundForDay = true; // Flag para verificar se todos os exerc√≠cios foram encontrados

                const exercisesForPdfTable = []; // Collect exercises for PDF table in order
                const htmlExerciseList = []; // Collect HTML list items for display

                gruposDoDia.forEach(grupo => {
                    const numExerciciosParaGrupo = distribuicaoExerciciosPorGrupo[grupo] || 0;
                    if (numExerciciosParaGrupo === 0) return; // Skip if no exercises for this group

                    let availableExercisesForGroup = bancoDeExercicios[grupo] ? bancoDeExercicios[grupo][nivel] : [];

                    // Step 1: Filter by optional equipment first
                    let equipmentFilteredExercises = availableExercisesForGroup.filter(ex => {
                        const equipmentType = ex.equipamento[0];
                        switch (equipmentType) {
                            case "Faixa El√°stica": return includeElastic;
                            case "Peso Corporal": return includeBodyweight;
                            case "Cabos": return includeCables;
                            case "Kettlebell": return includeKettlebell;
                            case "Barra":
                            case "Halteres":
                            case "M√°quina":
                            case "Barra Fixa / Paralela":
                            case "Outros Acess√≥rios":
                            case "Diversos":
                                return true;
                            default:
                                return true;
                        }
                    });

                    // Step 2: Separate by difficulty levels for intelligent picking
                    let beginnerExercises = equipmentFilteredExercises.filter(ex => ex.difficulty === "Iniciante");
                    let intermediateExercises = equipmentFilteredExercises.filter(ex => ex.difficulty === "Intermediario");
                    let advancedExercises = equipmentFilteredExercises.filter(ex => ex.difficulty === "Avancado");

                    let selectedExercisesForGroup = [];
                    let attempts = 0;
                    const maxAttemptsPerExercise = 50; // Limit attempts to find a unique exercise

                    // Prioritize difficulty based on level
                    if (nivel === "Iniciante") {
                        // Try to fill with beginner exercises
                        while (selectedExercisesForGroup.length < numExerciciosParaGrupo && beginnerExercises.length > 0 && attempts < maxAttemptsPerExercise * numExerciciosParaGrupo) {
                            const randomIndex = Math.floor(Math.random() * beginnerExercises.length);
                            const exercise = beginnerExercises[randomIndex];
                            if (!exerciciosJaUsadosNoDia.has(exercise.nome)) {
                                selectedExercisesForGroup.push(exercise);
                                exerciciosJaUsadosNoDia.add(exercise.nome);
                                beginnerExercises.splice(randomIndex, 1); // Remove to prevent re-picking from this temp array
                            }
                            attempts++;
                        }
                        // If still not enough, try intermediate exercises
                        attempts = 0; // Reset attempts
                        while (selectedExercisesForGroup.length < numExerciciosParaGrupo && intermediateExercises.length > 0 && attempts < maxAttemptsPerExercise * numExerciciosParaGrupo) {
                            const randomIndex = Math.floor(Math.random() * intermediateExercises.length);
                            const exercise = intermediateExercises[randomIndex];
                            if (!exerciciosJaUsadosNoDia.has(exercise.nome)) {
                                selectedExercisesForGroup.push(exercise);
                                exerciciosJaUsadosNoDia.add(exercise.nome);
                                intermediateExercises.splice(randomIndex, 1);
                            }
                            attempts++;
                        }
                    } else if (nivel === "Intermediario") {
                        // Try intermediate first
                        while (selectedExercisesForGroup.length < numExerciciosParaGrupo && intermediateExercises.length > 0 && attempts < maxAttemptsPerExercise * numExerciciosParaGrupo) {
                            const randomIndex = Math.floor(Math.random() * intermediateExercises.length);
                            const exercise = intermediateExercises[randomIndex];
                            if (!exerciciosJaUsadosNoDia.has(exercise.nome)) {
                                selectedExercisesForGroup.push(exercise);
                                exerciciosJaUsadosNoDia.add(exercise.nome);
                                intermediateExercises.splice(randomIndex, 1);
                            }
                            attempts++;
                        }
                        // Then beginner
                        attempts = 0;
                        while (selectedExercisesForGroup.length < numExerciciosParaGrupo && beginnerExercises.length > 0 && attempts < maxAttemptsPerExercise * numExerciciosParaGrupo) {
                            const randomIndex = Math.floor(Math.random() * beginnerExercises.length);
                            const exercise = beginnerExercises[randomIndex];
                            if (!exerciciosJaUsadosNoDia.has(exercise.nome)) {
                                selectedExercisesForGroup.push(exercise);
                                exerciciosJaUsadosNoDia.add(exercise.nome);
                                beginnerExercises.splice(randomIndex, 1);
                            }
                            attempts++;
                        }
                        // Finally advanced (as a last resort for variety/completeness)
                        attempts = 0;
                        while (selectedExercisesForGroup.length < numExerciciosParaGrupo && advancedExercises.length > 0 && attempts < maxAttemptsPerExercise * numExerciciosParaGrupo) {
                            const randomIndex = Math.floor(Math.random() * advancedExercises.length);
                            const exercise = advancedExercises[randomIndex];
                            if (!exerciciosJaUsadosNoDia.has(exercise.nome)) {
                                selectedExercisesForGroup.push(exercise);
                                exerciciosJaUsadosNoDia.add(exercise.nome);
                                advancedExercises.splice(randomIndex, 1);
                            }
                            attempts++;
                        }
                    } else { // Avancado
                        // For advanced, all are fair game. Combine and shuffle.
                        let allEligibleForAdvanced = [...beginnerExercises, ...intermediateExercises, ...advancedExercises];
                        allEligibleForAdvanced.sort(() => 0.5 - Math.random()); // Shuffle for randomness

                        while (selectedExercisesForGroup.length < numExerciciosParaGrupo && allEligibleForAdvanced.length > 0 && attempts < maxAttemptsPerExercise * numExerciciosParaGrupo) {
                            const exercise = allEligibleForAdvanced.shift(); // Take from the beginning
                            if (exercise && !exerciciosJaUsadosNoDia.has(exercise.nome)) {
                                selectedExercisesForGroup.push(exercise);
                                exerciciosJaUsadosNoDia.add(exercise.nome);
                            }
                            attempts++;
                        }
                    }

                    // If still not enough, it means the pool of exercises is truly exhausted for this group
                    if (selectedExercisesForGroup.length < numExerciciosParaGrupo) {
                        console.warn(`Aviso: N√£o foi poss√≠vel encontrar o n√∫mero desejado de exerc√≠cios (${numExerciciosParaGrupo}) para o grupo ${grupo} no n√≠vel ${nivel}. Encontrados: ${selectedExercisesForGroup.length}.`);
                        // We will proceed with the exercises found, even if fewer than desired.
                    }
                    
                    // Add to ordered list for PDF and HTML
                    if (selectedExercisesForGroup.length > 0) {
                        htmlExerciseList.push(`<h4>--- ${grupo} ---</h4><ul>`); // Sub-t√≠tulo para o grupo muscular
                        selectedExercisesForGroup.forEach(exercicio => {
                            let execucaoText = `${getSeriesRepeticoes(objetivo, nivel)} | Descanso: ${getDescanso(objetivo)}`;
                            let tecnicaAplicada = "";
                            
                            // L√≥gica de Aplica√ß√£o Inteligente de T√©cnicas
                            if (tecnicasUnicas.length > 0 && tecnicasAplicadasNesteDia < maxTecnicasPorDia) {
                                // Aumenta a chance de aplicar t√©cnica para n√≠veis mais avan√ßados
                                const chanceTecnica = (nivel === "Avancado" ? 0.6 : (nivel === "Intermediario" ? 0.3 : 0.05)); // Reduced chance for beginner
                                if (Math.random() < chanceTecnica) {
                                    const tecnicaForThisExercise = tecnicasUnicas[Math.floor(Math.random() * tecnicasUnicas.length)];
                                    execucaoText += ` | T√©cnica: ${tecnicaForThisExercise}`;
                                    tecnicaAplicada = tecnicaForThisExercise;
                                    tecnicasAplicadasNesteDia++;
                                }
                            }

                            htmlExerciseList.push(`<li><strong>${exercicio.nome}</strong> (${exercicio.equipamento.join(', ')}) - ${execucaoText}`);
                            if (exercicio.instrucoes) { // Removed nivel check, instructions are always useful
                                htmlExerciseList.push(` <br> <em>Instru√ß√µes: ${exercicio.instrucoes}</em>`);
                            }
                            htmlExerciseList.push(`</li>`);

                            exercisesForPdfTable.push({
                                nome: exercicio.nome,
                                equipamento: exercicio.equipamento.join(', '),
                                execucao: getSeriesRepeticoes(objetivo, nivel),
                                descanso: getDescanso(objetivo),
                                tecnica: tecnicaAplicada || '-' // Se n√£o houver t√©cnica, mostra '-'
                            });
                        });
                        htmlExerciseList.push(`</ul>`);
                    }
                });

                const currentDayPdfData = {
                    dayName: diaLetra,
                    groups: gruposDoDia,
                    warmup: selectedWarmup,
                    exercises: [], // Ser√° preenchido com os exerc√≠cios ordenados
                    cardio: null,
                    motivationalPhrase: "Cada repeti√ß√£o √© um passo mais perto do seu objetivo! Mantenha o foco e supere-se!" // Motivational phrase
                };

                if (exercisesForPdfTable.length === 0) { // Check if any exercises were generated at all for the day
                    treinoOutputHTML += `<p style="color: #ffcccc;">N√£o foi poss√≠vel gerar exerc√≠cios para o Dia ${diaLetra}. Por favor, verifique a sua sele√ß√£o de grupos musculares, op√ß√µes de equipamentos e n√≠vel de treino para garantir que h√° exerc√≠cios dispon√≠veis.</p>\n`;
                    currentDayPdfData.exercises.push({
                        nome: `N√£o foi poss√≠vel gerar exerc√≠cios para o Dia ${diaLetra}.`,
                        equipamento: "",
                        execucao: "Verifique a configura√ß√£o.",
                        descanso: "",
                        tecnica: ""
                    });
                } else {
                    treinoOutputHTML += `<p><strong>üí™ Treino de For√ßa:</strong></p>${htmlExerciseList.join('\n')}`;
                    currentDayPdfData.exercises = exercisesForPdfTable; // Assign the ordered exercises
                }

                // Cardio (mantido - agora pode ser inclu√≠do em qualquer dia personalizado)
                // Para evitar cardio em *todos* os dias, podemos adicionar uma chance ou regra
                if (objetivo === "Emagrecimento" || Math.random() > 0.4) { // Sempre inclui para Emagrecimento, 60% de chance para outros
                    const availableCardio = cardioExercises[nivel];
                    if (availableCardio && availableCardio.length > 0) {
                        const cardioEscolhido = availableCardio[Math.floor(Math.random() * availableCardio.length)];
                        let cardioText = cardioEscolhido.nome;
                        if (objetivo === "Emagrecimento") {
                            cardioText += " - Mantenha a intensidade para maximizar a queima de gordura!";
                        }
                        treinoOutputHTML += `<p><strong>üèÉ Cardio:</strong> ${cardioText}</p>\n`;
                        currentDayPdfData.cardio = cardioText;
                    } else {
                         treinoOutputHTML += `<p><strong>üèÉ Cardio:</strong> N√£o foi poss√≠vel gerar um exerc√≠cio de cardio para este n√≠vel.</p>\n`;
                         currentDayPdfData.cardio = "N√£o foi poss√≠vel gerar um exerc√≠cio de cardio para este n√≠vel.";
                    }
                }

                // Motivational Phrase
                treinoOutputHTML += `<p><strong>üåü Motiva√ß√£o:</strong> ${currentDayPdfData.motivationalPhrase}</p>\n`;
                
                treinoOutputHTML += `\n<hr style="border-color: rgba(255,255,255,0.3);">\n`;
                treinoGeradoConteudoParaPDF.dias.push(currentDayPdfData);
            }); // Fim do loop customDivisionsData

            resultadoDiv.innerHTML = treinoOutputHTML;
            // treinoGeradoConteudoHTML j√° est√° salvo
            // treinoGeradoConteudoParaPDF j√° est√° preenchido
        }

        // --- L√ìGICA DE EXPORTA√á√ÉO PARA PDF ---
        function exportarTreinoParaPDF() {
            if (!treinoGeradoConteudoParaPDF.aluno) {
                alert("Por favor, gere um treino primeiro antes de exportar para PDF.");
                return;
            }

            const doc = new window.jspdf.jsPDF();
            const { aluno, sexo, nivel, objetivo, tecnicas, observacoes, dias } = treinoGeradoConteudoParaPDF;
            
            const margin = 15;
            let yOffset = margin;
            const lineHeight = 7;
            const pageWidth = doc.internal.pageSize.getWidth();

            // Fun√ß√£o para adicionar cabe√ßalho e rodap√© a cada p√°gina
            const addPageContent = () => {
                doc.setFontSize(10);
                doc.setTextColor(150, 150, 150);
                doc.text("Gerado por seu Treinador Pessoal.", margin, doc.internal.pageSize.getHeight() - 10);
                doc.text(`P√°gina ${doc.internal.getNumberOfPages()}`, pageWidth - margin, doc.internal.pageSize.getHeight() - 10, { align: 'right' });
            };

            // T√≠tulo Principal
            doc.setFontSize(22);
            doc.setTextColor(30, 78, 114); // Azul escuro
            doc.text(`Treino Personalizado para ${aluno}`, pageWidth / 2, yOffset, { align: 'center' });
            yOffset += lineHeight * 2;

            doc.setDrawColor(200, 200, 200); // Cor cinza clara para a linha
            doc.line(margin, yOffset, pageWidth - margin, yOffset); // Linha separadora
            yOffset += lineHeight;

            doc.setFontSize(12);
            doc.setTextColor(50, 50, 50); // Quase preto

            // Informa√ß√µes Gerais do Treino
            doc.text(`N√≠vel: ${nivel}`, margin, yOffset);
            yOffset += lineHeight;
            doc.text(`Objetivo: ${objetivo}`, margin, yOffset);
            yOffset += lineHeight;
            doc.text(`Sexo: ${sexo}`, margin, yOffset);
            yOffset += lineHeight;

            if (tecnicas.length > 0) {
                doc.text(`T√©cnicas Avan√ßadas: ${tecnicas.join(', ')}`, margin, yOffset);
                yOffset += lineHeight;
            }
            if (observacoes) {
                // Quebra de texto para observa√ß√µes
                const obsLines = doc.splitTextToSize(`Observa√ß√µes: ${observacoes}`, pageWidth - 2 * margin);
                doc.text(obsLines, margin, yOffset);
                yOffset += lineHeight * obsLines.length;
            }
            yOffset += lineHeight; // Espa√ßo ap√≥s informa√ß√µes gerais

            doc.line(margin, yOffset, pageWidth - margin, yOffset); // Linha separadora
            yOffset += lineHeight * 1.5; // Mais espa√ßo antes do primeiro dia

            // Iterar sobre os dias de treino
            dias.forEach((dia, index) => {
                // Adicionar nova p√°gina se n√£o houver espa√ßo suficiente para o pr√≥ximo dia
                if (yOffset + 50 > doc.internal.pageSize.getHeight() - margin) { // 50 √© uma estimativa de altura para o t√≠tulo do dia + aquecimento
                    doc.addPage();
                    yOffset = margin;
                    addPageContent(); // Adiciona cabe√ßalho/rodap√© √† nova p√°gina
                    yOffset += lineHeight * 2; // Espa√ßo ap√≥s cabe√ßalho
                }

                // T√≠tulo do Dia
                doc.setFontSize(16);
                doc.setTextColor(30, 78, 114);
                doc.text(`DIA ${dia.dayName}: ${dia.groups.join(' + ')}`, margin, yOffset);
                yOffset += lineHeight * 1.5;

                // Aquecimento
                doc.setFontSize(12);
                doc.setTextColor(50, 50, 50);
                doc.text('Aquecimento Geral (5-10 min):', margin, yOffset);
                yOffset += lineHeight;
                dia.warmup.forEach(item => {
                    doc.text(`  - ${item}`, margin, yOffset);
                    yOffset += lineHeight;
                });
                yOffset += lineHeight; // Espa√ßo ap√≥s aquecimento

                // Tabela de Exerc√≠cios de For√ßa
                const tableHeaders = [['Exerc√≠cio', 'Equipamento', 'S√©ries/Repeti√ß√µes', 'Descanso', 'T√©cnica']];
                const tableData = dia.exercises.map(ex => [
                    ex.nome,
                    ex.equipamento,
                    ex.execucao,
                    ex.descanso,
                    ex.tecnica || '-' // Se n√£o houver t√©cnica, mostra '-'
                ]);

                doc.autoTable({
                    startY: yOffset,
                    head: tableHeaders,
                    body: tableData,
                    theme: 'grid', // 'striped', 'grid', 'plain'
                    styles: {
                        font: 'helvetica',
                        fontSize: 10,
                        cellPadding: 2,
                        lineColor: 200,
                        lineWidth: 0.1
                    },
                    headStyles: {
                        fillColor: [69, 123, 157], // Azul m√©dio
                        textColor: [255, 255, 255],
                        fontStyle: 'bold'
                    },
                    bodyStyles: {
                        textColor: [50, 50, 50]
                    },
                    alternateRowStyles: {
                        fillColor: [240, 240, 240] // Cinza claro para linhas alternadas
                    },
                    margin: { left: margin, right: margin },
                    didDrawPage: (data) => {
                        // Adiciona cabe√ßalho/rodap√© em cada p√°gina da tabela
                        addPageContent();
                    }
                });

                yOffset = doc.autoTable.previous.finalY + lineHeight; // Pega a posi√ß√£o final da tabela

                // Cardio (se houver)
                if (dia.cardio) {
                    if (yOffset + 2 * lineHeight > doc.internal.pageSize.getHeight() - margin) {
                        doc.addPage();
                        yOffset = margin;
                        addPageContent();
                        yOffset += lineHeight * 2;
                    }
                    doc.setFontSize(12);
                    doc.setTextColor(50, 50, 50);
                    const cardioLines = doc.splitTextToSize(`Cardio: ${dia.cardio}`, pageWidth - 2 * margin);
                    doc.text(cardioLines, margin, yOffset);
                    yOffset += lineHeight * cardioLines.length;
                }
                yOffset += lineHeight; // Espa√ßo ap√≥s cardio

                // Motivational Phrase
                if (dia.motivationalPhrase) {
                    if (yOffset + 2 * lineHeight > doc.internal.pageSize.getHeight() - margin) {
                        doc.addPage();
                        yOffset = margin;
                        addPageContent();
                        yOffset += lineHeight * 2;
                    }
                    doc.setFontSize(12);
                    doc.setTextColor(50, 50, 50);
                    const phraseLines = doc.splitTextToSize(`üåü Motiva√ß√£o: ${dia.motivationalPhrase}`, pageWidth - 2 * margin);
                    doc.text(phraseLines, margin, yOffset);
                    yOffset += lineHeight * phraseLines.length;
                }
                yOffset += lineHeight * 2; // Espa√ßo extra entre os dias
            });

            // Adiciona cabe√ßalho/rodap√© √† √∫ltima p√°gina, se necess√°rio
            addPageContent();
            
            doc.save(`treino_${aluno.replace(/\s/g, '_').toLowerCase()}.pdf`);
        }
    </script>
</body>
</html>
